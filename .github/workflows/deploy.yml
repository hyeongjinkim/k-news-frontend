name: Deploy to Vultr Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.REMOTE_SSH_KEY }}
        script: |
          # --- Frontend Deployment ---
          echo ">>> Deploying Frontend..."
          cd /home/k-news-admin/k-news-frontend
          git pull
          npm install
          npm run build
          pm2 restart k-news-frontend

          # --- Backend Deployments ---
          echo ">>> Deploying Backend..."
          cd /home/k-news-admin/seoulsync/backend
          git pull
          
          # ecosystem.config.js를 사용하여 안정적으로 재시작
          # 이 명령어는 pm2가 ecosystem 파일에 정의된 interpreter와 cwd를 사용하게 함
          pm2 startOrRestart ecosystem.config.js
          
          # pm2가 관리하는 프로세스 목록을 저장하여 서버 재부팅 시에도 유지
          pm2 save
          
          echo ">>> Deployment Finished!"